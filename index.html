<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>Blitzboard</title>
<link crossorigin='anonymous' href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' integrity='sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh' rel='stylesheet'>
<link href='/apple-touch-icon.png' rel='apple-touch-icon' sizes='180x180'>
<link href='/favicon-32x32.png' rel='icon' sizes='32x32' type='image/png'>
<link href='/favicon-16x16.png' rel='icon' sizes='16x16' type='image/png'>
<link href='/site.webmanifest' rel='manifest'>
<link color='#848484' href='/safari-pinned-tab.svg' rel='mask-icon'>
<meta content='#ffffff' name='msapplication-TileColor'>
<meta content='#ffffff' name='theme-color'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet'>
<link href='https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css' rel='stylesheet'>
<link href='./css/jquery-ui.min.css' rel='stylesheet'>
<link href='./lib/codemirror/codemirror.css' rel='stylesheet'>
<link href='./lib/monokai.css' rel='stylesheet'>
<link href='./lib/codemirror/addon/show-hint.css' rel='stylesheet'>
<link href='./favicon.ico' rel='shortcut icon' type='image/x-icon'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css' rel='stylesheet'>
<script src='./axios.min.js'></script>
<script src='./vis-network.min.js'></script>
<script src='./manipulations.js'></script>
<script src='./lib/jquery-3.5.1.min.js'></script>
<script src='./lib/jquery-ui.min.js'></script>
<script src='./lib/pg_parser_browserified.js' type='text/javascript'></script>
<script src='./lib/json2pg_browserified.js' type='text/javascript'></script>
<script src='./lib/codemirror/codemirror.js'></script>
<script src='./lib/codemirror/simple.js'></script>
<script src='./lib/codemirror/pg_mode.js'></script>
<script src='./lib/codemirror/mark-selection.js'></script>
<script src='./lib/codemirror/javascript_mode.js'></script>
<script src='./lib/codemirror/addon/show-hint.js'></script>
<script src='./lib/codemirror/addon/anyword-hint.js'></script>
<script src='./lib/util.js'></script>
<script src='./lib/diff.js'></script>
<script src='./config.js'></script>
<script src='./gui.js'></script>
<script src='./animation.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js'></script>
<style>
  #network-popUp {
      display: none;
      position: absolute;
      top: 350px;
      left: 170px;
      z-index: 299;
      width: 250px;
      background-color: #f9f9f9;
      border-style: solid;
      border-width: 3px;
      border-color: #5394ed;
      padding: 10px;
      text-align: center;
  }
  
  .dg.main .close-button {
      background-color: rgba(0, 0, 0, 0.7);
  }
  
  .dg.main .close-button:hover {
      background-color: rgba(0, 0, 0, 0.7);
  }
  
  .dg li:not(.folder) {
      background: rgba(0, 0, 0, 0.7);
  }
  
  .dg li.title {
      background: rgba(0, 0, 0, 0.7) url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;
  }
  
  #pg-area {
    height:100%
  }
  
  #input-area {
    left: 0;
    width: 50%;
  }
  
  #config-area {
    flex: 1;
    height: 0%;
  }
  
  #graph-pane {
    flex: 1;
  }
  
  .ui-resizable-handle {
    background: #cccccc;
  }
  
  #main-area {
    display: inline-flex;
    width: 100%;
    height: calc(100vh - 60px);
  }
  
  .float-btn {
    position: absolute;
    width: 40px;
    height: 40px;
    right: 10px;
    bottom: 10px;
  }
  
  #embed-btn {
    right: 110px;
  }
  
  #export-btn {
    width: 80px;
  }
  
  #share-btn {
    width: 80px;
  }
  
  #config-btn {
    z-index: 999;
    background: #272822;
    border: #272822;
  }
  
  #reset-config-btn {
    z-index: 995;
    background: #272822;
    border: #272822;
  }
  
  span .highlighted {
    background: rgba(200, 200, 0, 0.5);
  }
  
  span .syntax-error {
    background: rgba(255, 0, 0, 0.7);
    border-bottom: red;
  }
  
  span .syntax-error-line {
    background: rgba(255, 0, 0, 0.4);
  }
  
  #header { 
    background: #151515 !important;
    height: 60px;
  }
  
  .toast-top-right {
    top: 70px;
  }
  
  .dropdown-toggle {
    -webkit-appearance: none;
    border-radius: 0;
  }
  
  .CodeMirror-selected  { background-color: rgba(200, 200, 100, 0.5) !important; }
  
  .CodeMirror {
    font-family: 'Courier', monospace;
    font-size: 16px;
  }
</style>
</head>
<body>
<div id='app'>
<nav class='navbar navbar-expand-md navbar-light bg-white shadow-sm sticky-top' id='header'>
<div class='mr-5' style='color: yellow'>
<img src='./blitzboard-w_3.png' style='height: 30px;'>
</div>
<div class='btn-group btn-group-toggle' data-toggle='buttons'>
<label class='btn btn-secondary column-mode-btn' data-placement='bottom' data-toggle='tooltip' id='input-only-btn' title='Show input area only'>
<input autocomplete='off' name='options' type='radio'>
<svg class='bi bi-file-text' fill='currentColor' height='16' viewbox='0 0 16 16' width='16' xmlns='http://www.w3.org/2000/svg'>
<path d='M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z'></path>
<path d='M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z'></path>
</svg>
</label>
<label class='btn btn-secondary column-mode-btn active' data-placement='bottom' data-toggle='tooltip' id='double-column-btn' title='Show both area'>
<input autocomplete='off' checked='checked' name='options' type='radio'>
<svg class='bi bi-columns' fill='currentColor' height='16' viewbox='0 0 16 16' width='16' xmlns='http://www.w3.org/2000/svg'>
<path d='M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V2zm8.5 0v8H15V2H8.5zm0 9v3H15v-3H8.5zm-1-9H1v3h6.5V2zM1 14h6.5V6H1v8z'></path>
</svg>
</label>
<label class='btn btn-secondary column-mode-btn' data-placement='bottom' data-toggle='tooltip' id='view-only-btn' title='Show graph area only'>
<input autocomplete='off' name='options' type='radio'>
<svg class='bi bi-diagram-2' fill='currentColor' height='16' viewbox='0 0 16 16' width='16' xmlns='http://www.w3.org/2000/svg'>
<path d='M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 5 7h2.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5a1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z' fill-rule='evenodd'></path>
</svg>
</label>
</div>
<ul class='navbar-nav justify-content-end' style='margin-left: auto; margin-right: 0;'>
<li class='nav-item'>
<div class='btn dropdown text-white mx-4' id='export-btn'>
<div aria-haspopup class='dropdown-toggle' data-toggle='dropdown' id='exportDropdown' type='button'>
Export
</div>
<div aria-labelledby='exportDropdown' class='dropdown-menu'>
<a class='dropdown-item' href='#' id='export-pgql-btn'>
PGQL
</a>
<a class='dropdown-item' href='#' id='embed-btn'>
Javascript
</a>
</div>
</div>
<li class='nav-item'>
<div class='btn text-white' href='#' id='share-btn' title='Share'>
Share
</div>
</li>
</li>
</ul>
</nav>
<div id='network-popUp'>
<span id='operation'>node</span>
<br>
<table style='margin: auto'>
<tbody id='popup-table'></tbody>
</table>
<input id='saveButton' type='button' value='save'>
<input id='cancelButton' type='button' value='cancel'>
</div>
<div id='main-area'>
<div id='input-area'>
<div id='pg-area'>
<input class='d-none' id='url-input'>
<textarea id='graph-input' style='height: 100%; width: 100%;'>I :person name:"your name"
You :person
Graph :graph
I -> Graph :say word:Hello date:today
You -> I :say word:Goodbye date:yesterday</textarea>
</div>
<div id='config-area'>
<textarea id='config-input' style='height: 100%; width: 100%;'></textarea>
</div>
</div>
<div class='h-100' id='graph-pane'>
<div class='bg-light h-100' id='graph'></div>
</div>
<div class='float-btn btn btn-info' id='config-btn' title='Config'>
<span class='ion-android-settings'></span>
</div>
<div class='float-btn btn btn-info' id='reset-config-btn' title='Reset Config'>
<span class='ion-android-refresh'></span>
</div>
</div>
</div>
<script src='./blitzboard.js'></script>
<script>
  let container = document.getElementById('graph'); 
  let timerId = 0;
  let editor, configEditor;
  let localMode = true;
  let blitzboard = new Blitzboard(container);
  let byProgram = true;
  let prevInputWidth = null;
  let config;
  
  
  function scrollToLine(loc) {
    byProgram = true;
    editor.scrollIntoView({line: loc.start.line - 1, ch: loc.start.column - 1}, 200);
    editor.setSelection({line: loc.start.line - 1, ch: loc.start.column - 1}, {line: loc.end.line - 1, ch: loc.end.column - 1});
    editor.focus();
  }
  
  q('#url-input').addEventListener('change', () => {
    clearTimeout(timerId);
    localMode = false;
    timerId = setTimeout(retrieveGraph, 1000);
  });
  
  q('#share-btn').addEventListener('click', () => {
    let url = `https://g2glab.github.io/hellograph?pg=${encodeURIComponent(editor.getValue())}` +
      `&config=${encodeURIComponent(configEditor.getValue())}`;
    navigator.clipboard.writeText(url).then(function() {
      alert("Your graph is now on clipboard!")
    });
  });
  
  function onResize(event, ui) {
    const totalWidth = $("#main-area").width();
    let width = $("#input-area").width();
    if(width > totalWidth) {
      width = totalWidth;
      $('#input-area').css('width', width);
    }
    $('#graph-pane').css('width', (totalWidth - width));
    onConfigResize(null, null);
  };
  
  function onConfigResize(event, ui) {
    const totalHeight = $("#input-area").height();
    let height = $("#pg-area").height();
    if(height > totalHeight) {
      height = totalHeight;
    }
    let left = $("#pg-area").width() - 50;
    let bottom = (totalHeight - height) + 10;
    $('#pg-area').css('height', height);
    $('#config-area').css('height', (totalHeight - height));
    $('#config-btn').css('bottom', bottom);
    $('#config-btn').css('left', left);
    $('#reset-config-btn').css('left', left);
    $('#reset-config-btn').css('bottom', bottom - 70);
  };
  
  
  function updateGraph(event, ui) {
    blitzboard.updateGraph(editor.getValue(), config);
    if(blitzboard.network)
      blitzboard.network.on("click", (e) => {
        if(e.nodes.length > 0) {
          let node = blitzboard.nodeMap[e.nodes[0]];
          scrollToLine(node.location);
        } else if(e.edges.length > 0) {
          let edge = blitzboard.edgeMap[e.edges[0]];
          scrollToLine(edge.location);
        }
      });
  }
  
  window.onresize = onResize;
  $('#input-area').resizable({handles: "e,s", grid: [1, 10000]}).bind( "resize", onResize).bind("create", onResize);
  $('#pg-area').resizable({handles: "s", grid: [10000, 1]}).bind("resize", onConfigResize);
  
  onConfigResize(null, null);
  
  q('#config-btn').addEventListener('click', () => {
    let x = $('#config-area').css('height');
    if ($('#config-area').css('height') == '0px') {
      $('#pg-area').css('height', '50%');
      $('#config-area').css('height', '50%');
    } else {
      $('#pg-area').css('height', '100%');
      $('#config-area').css('height', '0%');
    }
    onConfigResize(null, null);
  });
  
  $('.column-mode-btn input').change(() => {
  
    if(!$('#input-area').resizable( "option", "disabled"))
      prevInputWidth = $('#input-area').css('width');
    if(q('#input-only-btn input').checked) {
      $('#input-area').resizable('disable');
      $('#input-area').css('width', '100%');
      $('#graph-pane').css('width', '0px');
    } else if(q('#double-column-btn input').checked) {
      const totalWidth = $("#main-area").width();
      $('#input-area').resizable('enable');
      $('#input-area').css('width', prevInputWidth);
      $('#graph-pane').css('width', totalWidth - prevInputWidth);
    } else if(q('#view-only-btn input').checked) { 
      $('#input-area').resizable('disable');
      $('#input-area').css('width', '0px');
      $('#graph-pane').css('width', '100%');
    }
    onResize(null, null);
  });
  
  
  q('#embed-btn').addEventListener('click', () => {
    content = `
      let blitzboard;
      window.addEventListener("load",function() {
      let container = document.getElementById('graph');
      blitzboard = new Blitzboard(container);
      let config = ${configEditor.getValue()}
      let graph = ${JSON.stringify(blitzboard.graph)};
      blitzboard.updateGraph(graph, config);
      });
    `;
    download(content, 'embed_pg.js', 'text/plain');
  });
  
  q('#reset-config-btn').addEventListener('click', () => {
    if(confirm("Really reset config?"))
      configEditor.setValue(defaultConfig);
  });
  
  q('#export-pgql-btn').addEventListener('click', () => {
    //download(editor.getValue(), 'graph_' + currentTimeString() + '.pg', 'text/plain');
  
    let pg = pgParser.parse(editor.getValue());
    let output = "";
    pg.nodes.forEach(node => {
      let node_label = (node.labels[0] === undefined) ? "UNDEFINED" : node.labels[0]
      let query = "";
      query = query + "INSERT INTO <graph_name> ";
      query = query + "VERTEX v LABELS (\"" + node_label.toUpperCase() + "\") "; // Restriction: single vertex label
      query = query + "PROPERTIES (";
      query = query + "v.id = '" + node.id + "'"; // ID is stored as a string property
      for (let entry of Object.entries(node.properties)) {
        query = query + ", v.\"" + entry[0].toUpperCase() + "\" = '" + entry[1] + "'"; // values are always stored as sting
      }
      query = query + ");";
      output = output + query + '\n';
    });
    pg.edges.forEach(edge => {
      let edge_label = (edge.labels[0] === undefined) ? "UNDEFINED" : edge.labels[0]
      let query = "";
      query = query + "INSERT INTO <graph_name> "
      query = query + "EDGE e BETWEEN src AND dst LABELS (\"" + edge_label.toUpperCase() + "\") " // Restriction: single vertex label
      query = query + "PROPERTIES ("
      query = query + "e.direction = '" + edge.direction + "'";
      for (let entry of Object.entries(edge.properties)) {
        query = query + ", e.\"" + entry[0].toUpperCase() + "\" = '" + entry[1] + "'"; // values are always stored as sting
      }
      query = query + ") ";
      query = query + "FROM MATCH (src) ON <graph_name>, MATCH (dst) ON <graph_name> ";
      query = query + "WHERE src.id = '" + edge.from + "' AND dst.id = '" + edge.to + "';";
      output = output + query + '\n';
    });
    download(output, 'graph_' + currentTimeString() + '.pgql', 'text/plain');
  });
  
  editor = CodeMirror.fromTextArea(q('#graph-input'), {
    lineNumbers: true,
    viewportMargin: Infinity,
    theme: "monokai",
    lineWrapping: true,
    mode: "pgMode",
    extraKeys: {
      Tab: 'autocomplete'
    },
    hintOptions: {
      completeSingle: false
    }
  });
  editor.setSize('100%', '100%');
  
  configEditor = CodeMirror.fromTextArea(q('#config-input'), {
    viewportMargin: Infinity,
    theme: "monokai",
    mode: 'javascript',
    lineWrapping: true,
    extraKeys: {
      Tab: 'autocomplete'
    },
    hintOptions: {
      completeSingle: false
    }
  });
  configEditor.setSize('100%', '100%');
  
  editor.on("inputRead", (instance) => {
    editor.execCommand('autocomplete', { completeSingle: false });
  });
        
  editor.on('change', (delta) => {
    if(!byProgram) {
      clearTimeout(timerId);
      localMode = true;
      timerId = setTimeout(() => {
      
        localStorage.setItem('pg', editor.getValue());
        updateGraph(editor.getValue(), config);
      }, 1000);
    } else {
      byProgram = false;
    }
  });
  
  editor.on('cursorActivity', (doc) => {
    if(!byProgram) {
      const node = blitzboard.nodeLineMap[doc.getCursor().line + 1];
      const edge = blitzboard.edgeLineMap[doc.getCursor().line + 1];
  
      if(node) {
        scrollIntoView(blitzboard.network.getPosition(node.id));
        blitzboard.network.selectNodes([node.id]);
      } else if(edge){
        const from = blitzboard.network.getPosition(edge.from);
        const to = blitzboard.network.getPosition(edge.to);
        scrollIntoView({ x: (from.x + to.x) / 2, y: (from.y + to.y) /2 });
        blitzboard.network.selectEdges([edge.id]);
      }
    } else {
      byProgram = false;
    }
  });
  
  const urlParams = new URLSearchParams(window.location.search);
  let pgInParam = urlParams.get('pg'), nodePropInParam = urlParams.get('displayedNodeProps'),
    edgePropInParam = urlParams.get('displayedEdgeProps');
  let configInParam = urlParams.get('config');
  if(pgInParam || nodePropInParam || edgePropInParam || configInParam) {
    if(pgInParam)
      localStorage.setItem('pg', pgInParam);
    if(configInParam)
      localStorage.setItem('config', configInParam);
    window.location.href = window.location.href.split('?')[0]; // Jump to URL without query parameter
  }
  
  
  let initialPg = loadConfig('pg');
  
  let configText = loadConfig('config');
  
  if (!configText) {
    configText = defaultConfig;
  }
  if(!config) {
    config = tryJsonParse(configText);
  }
  
  if(config?.x2?.init) {
    editor.setValue('');
    let strParams = '?';
    config.x2.init.parameters.forEach(parameter => {
      strParams = strParams + parameter.key + '=' + parameter.value + '&';
    });
    const strUrl = config.x2.url + config.x2.init.endpoint + strParams;
    axios.get(strUrl).then((response) => {
      editor.setValue(json2pg.translate(JSON.stringify(response.data.pg)));
    });
  }
  // Otherwise, load PG data from browser local storage
  else if(initialPg) {
    editor.setValue(initialPg);
  }
  
  configEditor.setValue(configText);
  configEditor.on('change', (delta) => {
    clearTimeout(timerId);
    timerId = setTimeout(() => {
      localStorage.setItem('config', configEditor.getValue());
      config = tryJsonParse(configEditor.getValue());
      updateGraph(editor.getValue(), config);
    }, 1000);
  });
  
  $('[data-toggle="tooltip"]').tooltip()
  
  
  if(editor.getValue())
    updateGraph(editor.getValue(), config);
</script>
</body>
</html>
