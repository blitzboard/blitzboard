<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Hello Graph</title>
    <link href='https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css' rel='stylesheet'>
    <script src='./vis-network.min.js'></script>
    <script src='./lib/pg_parser_browserified.js' type='text/javascript'></script>
    <script src='./lib/util.js'></script>
    <script src='./animation.js'></script>
</head>
<body>
<div class='bg-light vh-100' id='graph'></div>
</div>
<script src='./hello_graph.js'></script>
<script>
  let container = document.getElementById('graph');
  let timerId = 0;
  let editor, configEditor;
  let localMode = true;
  let helloGraph = new HelloGraph(container);
  let byProgram = true;


  function scrollToLine(loc) {
    byProgram = true;
    editor.scrollIntoView({line: loc.start.line - 1, ch: loc.start.column - 1}, 200);
    editor.setSelection({line: loc.start.line - 1, ch: loc.start.column - 1}, {line: loc.end.line - 1, ch: loc.end.column - 1});
    editor.focus();
  }

  q('#url-input').addEventListener('change', () => {
    clearTimeout(timerId);
    localMode = false;
    timerId = setTimeout(retrieveGraph, 1000);
  });

  q('#share-btn').addEventListener('click', () => {
    let url = `https://g2glab.github.io/hellograph?pg=${encodeURIComponent(editor.getValue())}` +
      `&config=${encodeURIComponent(configEditor.getValue())}`;
    navigator.clipboard.writeText(url).then(function() {
      alert("Your graph is now on clipboard!")
    });
  });

  function onResize(event, ui) {
    const totalWidth = $("#main-area").width();
    let width = $("#input-area").width();
    if(width > totalWidth) {
      width = totalWidth;
      $('#input-area').css('width', width);
    }
    $('#graph-pane').css('width', (totalWidth - width) - 100);
    onConfigResize(null, null);
  };

  function onConfigResize(event, ui) {
    const totalHeight = $("#input-area").height();
    let height = $("#pg-area").height();
    if(height > totalHeight) {
      height = totalHeight;
    }
    let left = $("#pg-area").width() - 50;
    let bottom = (totalHeight - height) + 10;
    $('#pg-area').css('height', height);
    $('#config-area').css('height', (totalHeight - height));
    $('#config-btn').css('bottom', bottom);
    $('#config-btn').css('left', left);
    $('#reset-config-btn').css('left', left);
    $('#reset-config-btn').css('bottom', bottom - 70);
  };

  window.onresize = onResize;
  $('#input-area').resizable({handles: "e,s", grid: [1, 10000]}).bind( "resize", onResize).bind("create", onResize);
  $('#pg-area').resizable({handles: "s", grid: [10000, 1]}).bind("resize", onConfigResize);

  onConfigResize(null, null);

  q('#config-btn').addEventListener('click', () => {
    let x = $('#config-area').css('height');
    if ($('#config-area').css('height') == '0px') {
      $('#pg-area').css('height', '50%');
      $('#config-area').css('height', '50%');
    } else {
      $('#pg-area').css('height', '100%');
      $('#config-area').css('height', '0%');
    }
    onConfigResize(null, null);
  });

  q('#reset-config-btn').addEventListener('click', () => {
    if(confirm("Really reset config?"))
      configEditor.setValue(defaultConfig);
  });

  q('#export-btn').addEventListener('click', () => {
    //download(editor.getValue(), 'graph_' + currentTimeString() + '.pg', 'text/plain');

    let pg = pgParser.parse(editor.getValue());
    let output = "";
    pg.nodes.forEach(node => {
      let node_label = (node.labels[0] === undefined) ? "UNDEFINED" : node.labels[0]
      let query = "";
      query = query + "INSERT INTO <graph_name> ";
      query = query + "VERTEX v LABELS (\"" + node_label.toUpperCase() + "\") "; // Restriction: single vertex label
      query = query + "PROPERTIES (";
      query = query + "v.id = '" + node.id + "'"; // ID is stored as a string property
      for (let entry of Object.entries(node.properties)) {
        query = query + ", v.\"" + entry[0].toUpperCase() + "\" = '" + entry[1] + "'"; // values are always stored as sting
      }
      query = query + ");";
      output = output + query + '\n';
    });
    pg.edges.forEach(edge => {
      let edge_label = (edge.labels[0] === undefined) ? "UNDEFINED" : edge.labels[0]
      let query = "";
      query = query + "INSERT INTO <graph_name> "
      query = query + "EDGE e BETWEEN src AND dst LABELS (\"" + edge_label.toUpperCase() + "\") " // Restriction: single vertex label
      query = query + "PROPERTIES ("
      query = query + "e.direction = '" + edge.direction + "'";
      for (let entry of Object.entries(edge.properties)) {
        query = query + ", e.\"" + entry[0].toUpperCase() + "\" = '" + entry[1] + "'"; // values are always stored as sting
      }
      query = query + ") ";
      query = query + "FROM MATCH (src) ON <graph_name>, MATCH (dst) ON <graph_name> ";
      query = query + "WHERE src.id = '" + edge.from + "' AND dst.id = '" + edge.to + "';";
      output = output + query + '\n';
    });
    download(output, 'graph_' + currentTimeString() + '.pgql', 'text/plain');
  });

  editor = CodeMirror.fromTextArea(q('#graph-input'), {
    lineNumbers: true,
    viewportMargin: Infinity,
    theme: "monokai",
    lineWrapping: true,
    mode: "pgMode",
    extraKeys: {
      Tab: 'autocomplete'
    },
    hintOptions: {
      completeSingle: false
    }
  });
  editor.setSize('100%', '100%');

  configEditor = CodeMirror.fromTextArea(q('#config-input'), {
    viewportMargin: Infinity,
    theme: "monokai",
    mode: 'javascript',
    lineWrapping: true,
    extraKeys: {
      Tab: 'autocomplete'
    },
    hintOptions: {
      completeSingle: false
    }
  });
  configEditor.setSize('100%', '100%');

  editor.on("inputRead", (instance) => {
    editor.execCommand('autocomplete', { completeSingle: false });
  });

  editor.on('change', (delta) => {
    if(!byProgram) {
      clearTimeout(timerId);
      localMode = true;
      console.log("hoooooooooooge");
      timerId = setTimeout(() => {
        helloGraph.updateGraph(editor.getValue(), config);
      }, 1000);
    } else {
      byProgram = false;
    }
  });

  editor.on('cursorActivity', (doc) => {
    if(!byProgram) {
      const node = helloGraph.nodeLineMap[doc.getCursor().line + 1];
      const edge = helloGraph.edgeLineMap[doc.getCursor().line + 1];

      if(node) {
        scrollIntoView(helloGraph.network.getPosition(node.id));
        helloGraph.network.selectNodes([node.id]);
      } else if(edge){
        const from = helloGraph.network.getPosition(edge.from);
        const to = helloGraph.network.getPosition(edge.to);
        scrollIntoView({ x: (from.x + to.x) / 2, y: (from.y + to.y) /2 });
        helloGraph.network.selectEdges([edge.id]);
      }
    } else {
      byProgram = false;
    }
  });

  const urlParams = new URLSearchParams(window.location.search);
  let pgInParam = urlParams.get('pg'), nodePropInParam = urlParams.get('displayedNodeProps'),
    edgePropInParam = urlParams.get('displayedEdgeProps');
  let configInParam = urlParams.get('config');
  if(pgInParam || nodePropInParam || edgePropInParam || configInParam) {
    if(pgInParam)
      localStorage.setItem('pg', pgInParam);
    if(configInParam)
      localStorage.setItem('config', configInParam);
    window.location.href = window.location.href.split('?')[0]; // Jump to URL without query parameter
  }


  let query = urlParams.get('query');
  let initialPg = loadConfig('pg');
  if(query) {
    editor.setValue('');
    axios.get(config.remoteUrl + query).then((response) => {
      editor.setValue(json2pg.translate(JSON.stringify(response.data.pg)));
    });
  }
  else if(initialPg) {
    editor.setValue(initialPg);
  }

  let configText = loadConfig('config');

  if (!configText) {
    configText = defaultConfig;
  }
  if(!config) {
    config = tryJsonParse(configText);
  }
  configEditor.setValue(configText);
  configEditor.on('change', (delta) => {
    clearTimeout(timerId);
    timerId = setTimeout(() => {
      localStorage.setItem('config', configEditor.getValue());
      config = tryJsonParse(configEditor.getValue());
      helloGraph.updateGraph(editor.getValue(), config);
    }, 1000);
  });

  helloGraph.updateGraph(editor.getValue(), config);
</script>
</body>
</html>
