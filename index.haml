!!!
%html
  %head
    %meta{:charset => "utf-8"}
    %title Blitzboard
    %link{:crossorigin => "anonymous", :href => "https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css", :integrity => "sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh", :rel => "stylesheet"}/
    %link{:href => "/apple-touch-icon.png", :rel => "apple-touch-icon", :sizes => "180x180"}/
    %link{:href => "/favicon-32x32.png", :rel => "icon", :sizes => "32x32", :type => "image/png"}/
    %link{:href => "/favicon-16x16.png", :rel => "icon", :sizes => "16x16", :type => "image/png"}/
    %link{:href => "/site.webmanifest", :rel => "manifest"}/
    %link{:color => "#848484", :href => "/safari-pinned-tab.svg", :rel => "mask-icon"}/
    %meta{:content => "#ffffff", :name => "msapplication-TileColor"}/
    %meta{:content => "#ffffff", :name => "theme-color"}/
    %link{:href => "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css", :rel => "stylesheet"}/
    %link{:href => "https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css", :rel => "stylesheet"}/
    %link{:href => "./css/jquery-ui.min.css", :rel => "stylesheet"}/
    %link{:href => "./lib/codemirror/codemirror.css", :rel => "stylesheet"}/
    %link{:href => "./lib/monokai.css", :rel => "stylesheet"}/
    %link{:href => "./lib/codemirror/addon/show-hint.css", :rel => "stylesheet"}/
    %link{:href => "./favicon.ico", :rel => "shortcut icon", :type => "image/x-icon"}/
    %link{:href => "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css", :rel => "stylesheet"}/
    %link{:href => "https://unpkg.com/leaflet@1.6.0/dist/leaflet.css", :integrity => "sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==", :crossorigin => "", :rel => "stylesheet"}/
    %script{:src => "https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"}
    %script{:src => "./vis-network.min.js"}
    %script{:src => "./manipulations.js"}
    %script{:src => "./lib/jquery-3.5.1.min.js"}
    %script{:src => "./lib/jquery-ui.min.js"}
    %script{:src => "./lib/pg_parser_browserified.js", :type => "text/javascript"}
    %script{:src => "./lib/json2pg_browserified.js", :type => "text/javascript"}
    %script{:src => "./lib/codemirror/codemirror.js"}
    %script{:src => "./lib/codemirror/simple.js"}
    %script{:src => "./lib/codemirror/pg_mode.js"}
    %script{:src => "./lib/codemirror/mark-selection.js"}
    %script{:src => "./lib/codemirror/javascript_mode.js"}
    %script{:src => "./lib/codemirror/addon/show-hint.js"}
    %script{:src => "./lib/codemirror/addon/anyword-hint.js"}
    %script{:src => "./lib/util.js"}
    %script{:src => "./lib/diff.js"}
    %script{:src => "./config.js"}
    %script{:src => "./gui.js"}
    %script{:src => "./animation.js"}
    %script{:src => "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"}
    %script{:src => 'https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'}
    %script{:src => "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"}
    %script{:src => "https://unpkg.com/leaflet@1.6.0/dist/leaflet.js", :integrity => "sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==", :crossorigin => ""}
    %script{:src => "https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js", :type => "module"}
    %script{:nomodule => "", :src => "https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"}
    %script{:src => "https://code.iconify.design/2/2.0.4/iconify.min.js"}
    %script{:src => "https://cdn.jsdelivr.net/npm/jszip@3.2.1/dist/jszip.js"}
    %script{:src => "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.4/FileSaver.min.js"}

    :css
      #network-popUp {
          display: none;
          position: absolute;
          top: 350px;
          left: 170px;
          z-index: 299;
          width: 250px;
          background-color: #f9f9f9;
          border-style: solid;
          border-width: 3px;
          border-color: #5394ed;
          padding: 10px;
          text-align: center;
      }

      .dg.main .close-button {
          background-color: rgba(0, 0, 0, 0.7);
      }

      .dg.main .close-button:hover {
          background-color: rgba(0, 0, 0, 0.7);
      }

      .dg li:not(.folder) {
          background: rgba(0, 0, 0, 0.7);
      }

      .dg li.title {
          background: rgba(0, 0, 0, 0.7) url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;
      }      
      
      #pg-area {
        height: 100%;
      }

      #input-area {
        left: 0;
        width: 50%;
      }

      #config-area {
        flex: 1;
        height: 0%;
      }

      #graph-pane {
        flex: 1;
        position: relative;
      }

      #graph {
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
        position:absolute;
        z-index: 2;
      }

      .ui-resizable-handle {
        background: #cccccc;
      }
      
      #main-area {
        display: inline-flex;
        width: 100%;
        height: calc(100vh - 50px);
      }

      .float-btn {
        position: absolute;
        width: 40px;
        height: 40px;
        right: 10px;
        bottom: 10px;
      }

      #embed-btn {
        right: 110px;
      }

      #import-btn-input {
        display: none;
      }

      #options-btn {
        z-index: 996;
        background: #272822;
        border: #272822;
      }

      #reset-config-btn {
        z-index: 995;
        background: #272822;
        border: #272822;
      }
      
      span .highlighted {
        background: rgba(200, 200, 0, 0.5);
      }
      
      span .syntax-error {
        background: rgba(255, 0, 0, 0.7);
        border-bottom: red;
      }
      
      span .syntax-error-line {
        background: rgba(255, 0, 0, 0.4);
      }
      
      #header { 
        background: #151515 !important;
        height: 50px;
      }

      .column-mode-btn {
        padding: 1px 12px 4px 12px;
      }
      
      .toast-top-right {
        top: 70px;
      }
      
      .dropdown-toggle {
        -webkit-appearance: none;
        border-radius: 0;
      }

      .dropdown-item.active {
        background: #047bff;
        color: black;
      }
      
      #history-dropdown.dropdown-toggle::after {
          display: inline-block;
          position: absolute;
          float: right;
          right: 5px;
          margin-top: 8px;
      }
      
      .CodeMirror-hints {
        z-index: 999 !important;
      }
      
      
      
      
      
      .CodeMirror {
        font-family: 'Courier', monospace;
        font-size: 16px;
      }
      
      
      .CodeMirror-scroll {
        padding: 0;
      }
      
      .dropdown-menu{
        max-height:600px;
        overflow-y:auto;
      }

  %body
    #app
      %nav#header.navbar.navbar-expand-md.navbar-light.bg-white.shadow-sm.sticky-top
        %div.mr-5{style: 'color: yellow', href: 'https://www.blitzboard.io/'}
          %a{href: 'https://www.blitzboard.io/'}
            %img{ src: './blitzboard-w_3.png', style: 'height: 23px;'}
        .btn-group.btn-group-toggle.mx-3{"data-toggle" => "buttons"}
          %label.btn.btn-secondary.column-mode-btn#input-only-btn{ 'data-toggle': 'tooltip', 'data-placement': 'bottom', title: 'Edit' }
            %input{:autocomplete => "off", :name => "options", :type => "radio"}/
            %svg.bi.bi-pencil{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
              %path{:d => "M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"}
          %label.btn.btn-secondary.column-mode-btn.active#double-column-btn{ 'data-toggle': 'tooltip', 'data-placement': 'bottom', title: 'Split' }
            %input{:autocomplete => "off", :checked => "checked", :name => "options", :type => "radio"}/
            %svg.bi.bi-layout-split{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
              %path{:d => "M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm8.5-1v12H14a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H8.5zm-1 0H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h5.5V2z"}
          %label.btn.btn-secondary.column-mode-btn#view-only-btn{ 'data-toggle': 'tooltip', 'data-placement': 'bottom', title: 'View' }
            %input{:autocomplete => "off", :name => "options", :type => "radio"}/
            %svg.bi.bi-eye{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
              %path{:d => "M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"}
              %path{:d => "M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"}
        #history-btn.btn.dropdown.text-white.mx-3
          #history-dropdown.dropdown-toggle{ type: 'button', 'data-toggle': 'dropdown', 'aria-haspopup': true, 'aria-expanded': false, style: "width: 200px; text-align: left; overflow: hidden; white-space: nowrap;text-overflow: ellipsis;" }
          #history-menu.dropdown-menu{ 'aria-labelledby': "historyDropdown" }
        %ul.navbar-nav.justify-content-end{ style: 'margin-left: auto; margin-right: 0;' }
          %li.nav-item
            %label.btn.text-white#new-btn{ title: "New", href: '#', 'data-toggle': 'tooltip', 'data-placement': 'bottom'}
              %svg.bi.bi-plus-lg{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
                %path{:d => "M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"}
          %li.nav-item
            %label.btn.text-white#import-btn{ title: "Import", href: '#', 'data-toggle': 'tooltip', 'data-placement': 'bottom'}
              %input#import-btn-input{ type: "file", accept: ".zip" }
                %svg.bi.bi-upload{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
                  %path{:d => "M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"}
                  %path{:d => "M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"}
          %li.nav-item
            %label.btn.dropdown.text-white#export-btn{ title: "Export", href: '#', 'data-toggle': 'tooltip', 'data-placement': 'bottom' }
              #export-dropdown{ 'data-toggle': 'dropdown', 'aria-haspopup': true, 'aria-expanded': false }
                %svg.bi.bi-download{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
                  %path{:d => "M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"}
                  %path{:d => "M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"}
              .dropdown-menu.dropdown-menu-right{ 'aria-labelledby': "export-dropdown" }
                %a#export-zip-btn.dropdown-item{ href: '#' }
                  Zip
                %a#export-cypher-btn.dropdown-item{ href: '#' }
                  Cypher Query
                %a#export-pgql-btn.dropdown-item{ href: '#' }
                  PGQL Query
                %a.dropdown-item#embed-btn{ href: '#' }
                  JavaScript
          %li.nav-item
            %label.btn.text-white#share-btn{ title: "Share", href: '#', 'data-toggle': 'tooltip', 'data-placement': 'bottom' }
              %svg.bi.bi-share-fill{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
                %path{:d => "M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"}
      #network-popUp
        %span#operation node
        %br/
        %table{:style => "margin: auto"}
          %tbody#popup-table
        %input#saveButton{:type => "button", :value => "save"}/
        %input#cancelButton{:type => "button", :value => "cancel"}/
      #main-area
        #input-area
          #pg-area
            -#%input#pgfile{:type => "file"}/
            %input#url-input.d-none/
            %textarea#graph-input{:style => "height: 100%; width: 100%;"}
              I :person name:"your name"
              You :person
              Graph :graph
              I -> Graph :say word:Hello date:today
              You -> I :say word:Goodbye date:yesterday
          #config-area
            %textarea#config-input{:style => "height: 100%; width: 100%;"}
        #graph-pane.h-100
          #graph.h-100
        %label.float-btn.btn.dropup.text-white#options-btn{ title: "Options", href: '#', 'data-toggle': 'tooltip', 'data-placement': 'top' }
          #options-dropdown{ 'data-toggle': 'dropdown', 'aria-haspopup': true, 'aria-expanded': false }
            %svg.bi.bi-gear-fill{:fill => "currentColor", :height => "16", :viewbox => "0 0 16 16", :width => "16", :xmlns => "http://www.w3.org/2000/svg"}
              %path{:d => "M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"}
          .dropdown-menu.dropdown-menu-right{ 'aria-labelledby': "options-dropdown" }
            %a#options-auto-complete.dropdown-item{ href: "#" }
              %input#options-auto-complete-input{ type: "checkbox", checked: "checked" }
              %label{:for => "options-auto-complete-input"} Auto Complete
            %a#options-show-config.dropdown-item{ href: "#" }
              %input#options-show-config-input{ type: "checkbox" }
              %label{:for => "options-show-config-input"} Show Config
        #reset-config-btn.float-btn.btn.btn-info{ title: "Reset Config", href: '#', 'data-toggle': 'tooltip', 'data-placement': 'bottom'}
          %span{:class => "ion-android-refresh" }
    %script{:src => "./blitzboard.js"}
    :javascript
      let container = document.getElementById('graph'); 
      let pgTimerId = null, configTimerId = null;
      let editor, configEditor;
      let localMode = true;
      let blitzboard = new Blitzboard(container);
      let byProgram = false;
      let prevInputWidth = null;
      let config, prevConfig;
      let autocompletion = true;
      let showConfig = false;
      let srcNode, lineEnd;
      let prevNetwork = null;
      let viewMode = loadConfig('viewMode');
      let savedGraphs = [];
      let candidatePropNames = new Set(), candidateLabels = new Set(), candidateIds = new Set();
      let dateTimeFormat = new Intl.DateTimeFormat('default', {
        year: 'numeric', month: 'numeric', day: 'numeric',
        hour: 'numeric', minute: 'numeric', second: 'numeric',
        hour12: false,
      });
      
      String.prototype.quoteIfNeeded = function() {
        if(this.includes('"') || this.includes('#') || this.includes('\t') || this.includes(':') || this.includes(' ')) {
          return `"${this.replace(/\"/g, '""')}"`;
        }
        return this;
      }
      

      if(!localStorage.getItem('currentGraphName')) {
        localStorage.setItem('currentGraphName', newGraphName());
      }
      
      function scrollToLine(loc) {
        if(!loc)
          return;
        byProgram = true;
        editor.scrollIntoView({line: loc.start.line - 1, ch: loc.start.column - 1}, 200);
        editor.setSelection({line: loc.start.line - 1, ch: loc.start.column - 1}, {line: loc.end.line - 1, ch: loc.end.column - 1});
        editor.focus();
        byProgram = false;
      }
      
      blitzboard.onNodeAdded.push((nodes) => {
        byProgram = true;
        let content = editor.getValue();
        for(let node of nodes) {
          content += `\n${node.id.quoteIfNeeded()}`;
          for(let label of node.labels)
            content += ` :${label.quoteIfNeeded()}`;
          for(let key in node.properties)
            for(let value of node.properties[key])
              content += ` ${key.quoteIfNeeded()}:${value.quoteIfNeeded()}`;
        }
        editor.setValue(content);
        byProgram = false;
        updateAutoCompletion();
        localStorage.setItem('pg', content);
      });
      
      blitzboard.onEdgeAdded.push((edges) => {
        byProgram = true;
        let content = editor.getValue();
        for(let edge of edges) {
          content += `\n${edge.from.quoteIfNeeded()} ${edge.direction} ${edge.to.quoteIfNeeded()}`;
          for(let label of edge.labels)
            content += ` :${label.quoteIfNeeded()}`;
          for(let key in edge.properties)
            for(let value of edge.properties[key])
              content += ` ${key.quoteIfNeeded()}:${value.quoteIfNeeded()}`;
        }
        editor.setValue(content);
        byProgram = false;
        updateAutoCompletion();
        localStorage.setItem('pg', content);
      });
      
      q('#url-input').addEventListener('change', () => {
        clearTimeout(pgTimerId);
        localMode = false;
        pgTimerId = setTimeout(retrieveGraph, 1000);
      });
      
        
      q('#share-btn').addEventListener('click', () => {
        let url = new URL(window.location);
        let params = new URLSearchParams();
        params.set('pg', editor.getValue());
        params.set('config', configEditor.getValue());
        params.set('viewMode', viewMode);
        params.set('name', localStorage.getItem('currentGraphName'));
        url.search = params;
        if(url.length > 7333) {
          alert("The content is too large for sharing via URI (Current: " + url.length + " / Max: 7333). Please export instead.");
        } else {
          if (!navigator.clipboard) {
              alert("Sharing is not allowed under non-secure HTTP. Please export your graph or use HTTPS.");
          } else { 
            navigator.clipboard.writeText(url.toString()).then(function() {
              alert("Your graph is now on clipboard!");
            });
          }
        }
      });
      
      function onResize(event, ui) {
        const totalWidth = $("#main-area").width();
        let width = $("#input-area").width();
        if(width > totalWidth) {
          width = totalWidth;
          $('#input-area').css('width', width);
        }
        localStorage.setItem('inputAreaWidth', width);
        $('#graph-pane').css('width', (totalWidth - width));
        onConfigResize(null, null);
      }
      
      function configCollapsed() {
        return $('#config-area').css('height') == '0px';
      }
      
      function onConfigResize(event, ui) {
        const totalHeight = $("#input-area").height();
        let height = $("#pg-area").height();
        if(height > totalHeight) {
          height = totalHeight;
        }
        let left = $("#pg-area").width() - 50;
        let bottom = (totalHeight - height) + 10;
        $('#pg-area').css('height', height);
        $('#config-area').css('height', (totalHeight - height));
        $('#options-btn').css('bottom', bottom);
        $('#options-btn').css('left', left);
        if(configCollapsed()) {
          $('#reset-config-btn').hide();
        } else {
          $('#reset-config-btn').show();
          $('#reset-config-btn').css('left', left);
          $('#reset-config-btn').css('bottom', bottom - 70);
        }
      };
      
      
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      
      function updateAutoCompletion() {
        candidateIds = new Set();
        candidatePropNames = new Set();
        candidateLabels = new Set();
        for(let node of blitzboard.graph.nodes) {
          candidateIds.add(node.id);
          for(let key in node.properties)
          {
            candidatePropNames.add(key);
          }
          for(let label of node.labels) {
            candidateLabels.add(':' + label);
          }
        }
        for(let edge of blitzboard.graph.edges) {
          for(let label of edge.labels) {
            candidateLabels.add(':' + label);
          }
          for(let key in edge.properties)
          {
            candidatePropNames.add(key);
          }
        }
      }
      
      function updateGraph(input, newConfig = null) {
        try {
          if(newConfig) {
            blitzboard.setGraph(input, false);
            blitzboard.setConfig(newConfig);
          } else {
            blitzboard.setGraph(input);
          } 
        } catch(e) {
            console.log(e);
            toastr.error(e.toString(), 'Error occured while rendering', {preventDuplicates: true})
            return null;
        }
        if(blitzboard.network !== prevNetwork) {
          blitzboard.network.on("click", (e) => {
            if(srcNode) {
              if(e.nodes.length > 0) {
                let node = blitzboard.nodeMap[e.nodes[0]];
                if(srcNode !== node.id) {
                  let oldPg = editor.getValue();
                  let lineNum = numberOfLines(oldPg) + 1;
                  editor.setValue(oldPg + `\n${srcNode.quoteIfNeeded()} -> ${node.id.quoteIfNeeded()}`);
                  updateGraph(editor.getValue());
                  scrollToLine({start: { line: lineNum, column: 1 }, end  : {line: lineNum + 1, column: 1}} );
                }
              }
              srcNode = null;
              lineEnd = null;
            } 
            else if(e.nodes.length > 0) {
              let node = blitzboard.nodeMap[e.nodes[0]];
              scrollToLine(node.location);
            } else if(e.edges.length > 0) {
              let edge = blitzboard.edgeMap[e.edges[0]];
              scrollToLine(edge.location);
            }
          });
          blitzboard.network.on("doubleClick", (e) => {
            if(!blitzboard.config?.node?.onDoubleClick) {
              if(e.nodes.length > 0) {
                const node = e.nodes[0];
                srcNode = node;
              } else if (blitzboard.map) {
                let xKey =  blitzboard.config.layoutSettings.x;
                let yKey =  blitzboard.config.layoutSettings.y;
                let oldPg = editor.getValue();
                let lineNum = numberOfLines(oldPg) + 1;
                let latLng = blitzboard.map.containerPointToLatLng([e.pointer.DOM.x, e.pointer.DOM.y]);
                editor.setValue(oldPg + `\n${newNodeName()} ${xKey}:${latLng.lng} ${yKey}:${latLng.lat}`);
                updateGraph(editor.getValue());
                scrollToLine({start: { line: lineNum, ch: 0 }, end: {line: lineNum, ch: 0}} );
              }
            }
          });
          let canvas = q(".vis-network canvas");
          canvas.addEventListener('mousemove', event =>
          {
            if(srcNode) {
              lineEnd = blitzboard.network.DOMtoCanvas(getMousePos(canvas, event));
              blitzboard.network.redraw();
            }
          });
          
          blitzboard.network.on("afterDrawing", (ctx) => {
            if(srcNode && lineEnd) {
              ctx.beginPath();
              let lineStart = blitzboard.network.getPosition(srcNode);
              ctx.moveTo(lineStart.x, lineStart.y);
              ctx.lineTo(lineEnd.x, lineEnd.y);
              ctx.stroke();
            }
          });
          prevNetwork = blitzboard.network;
        }
        if(blitzboard.graph) {
          updateAutoCompletion();
        }
      }
      
      window.onresize = onResize;
      $('#input-area').resizable({handles: "e,s", grid: [1, 10000]}).bind( "resize", onResize).bind("create", onResize);
      $('#pg-area').resizable({handles: "s", grid: [10000, 1]}).bind("resize", onConfigResize);
      
      onConfigResize(null, null);
      
      q('#options-show-config').addEventListener('click', () => {
        showOrHideConfig();
      });

      function showOrHideConfig() {
        if (q('#options-show-config-input').checked) {
          $('#pg-area').css('height', '50%');
          $('#config-area').css('height', '50%');
        } else {
          $('#pg-area').css('height', '100%');
          $('#config-area').css('height', '0%');
        }
        onConfigResize(null, null);
      }
      
      $('.column-mode-btn input').change(() => {
        if(!$('#input-area').resizable( "option", "disabled"))
          prevInputWidth = $('#input-area').css('width');
        if(q('#input-only-btn input').checked) {
          $('#input-area').resizable('disable');
          $('#input-area').css('width', '100%');
          $('#graph-pane').css('width', '0px');
          viewMode = 'input-only';
        } else if(q('#double-column-btn input').checked) {
          const totalWidth = $("#main-area").width();
          $('#input-area').resizable('enable');
          if(!prevInputWidth) 
            prevInputWidth = totalWidth / 2;
          $('#input-area').css('width', prevInputWidth);
          $('#graph-pane').css('width', totalWidth - prevInputWidth);
          viewMode = 'double-column';
        } else if(q('#view-only-btn input').checked) { 
          $('#input-area').resizable('disable');
          $('#input-area').css('width', '0px');
          $('#graph-pane').css('width', '100%');
          viewMode = 'view-only';
        }
        localStorage.setItem('viewMode', viewMode);
        onResize(null, null);
      });

      
      q('#embed-btn').addEventListener('click', () => {
        content = `
        window.addEventListener("load",function() {
        let blitzboard; 
        let container = document.getElementById('blitzboard');
        blitzboard = new Blitzboard(container);
        let config = ${configEditor.getValue()}
        let graph = ${JSON.stringify(blitzboard.graph)};
        blitzboard.setGraph(graph, false);
        blitzboard.setConfig(config);
        });
        `;
        let currentGraphName = localStorage.getItem('currentGraphName');
        let name = (currentGraphName.startsWith('Untitled') ? 'graph' : currentGraphName) + '_' + currentTimeString();
        saveAs(new Blob([content], { type: 'text/plain' }), name + '.js');
      });
      
      function newGraphName(baseName = 'Untitled') {
        let name = baseName;
        let i = 0;
        while(localStorage.getItem('saved-graph-' + name)) {
          name =  baseName + '-' + (++i);
        }
        return name;
      }
      
      
      function newNodeName(baseName = 'New') {
        let name = baseName;
        let i = 0;
        while(blitzboard.nodeDataSet.get(name)) {
          name =  baseName + '-' + (++i);
        }
        return name;
      }
      
      function showGraphName() {
        $('#history-dropdown')[0].innerText = localStorage.getItem('currentGraphName');
      }
      
      function loadSavedGraph() {
        savedGraphs = [];
        for (let i = 0; i < localStorage.length; i++){
          if ( localStorage.key(i).indexOf('saved-graph-') != -1 ) {
            try {
              savedGraphs.push(JSON.parse(localStorage.getItem(localStorage.key(i))));
            } catch(e) {
              localStorage.removeItem(localStorage.key(i));
            }
          }
        }
        
        let menu = q('#history-menu');
        // clear menu
        while (menu.firstChild) {
          menu.removeChild(menu.firstChild);
        }
        savedGraphs = savedGraphs.sort((a, b) => b.date - a.date);
        for(let graph of savedGraphs) {
          let node = document.createElement('a');
          node.className = 'dropdown-item history-item mr-3';
          if(graph.name === localStorage.getItem('currentGraphName'))
            node.className += ' active text-white'; 
          node.style = 'position:relative';
          node.appendChild(document.createTextNode(graph.name));
          node.appendChild(document.createElement("br"));
          node.appendChild(document.createTextNode(dateTimeFormat.format(new Date(graph.date))));
          let deleteButton = document.createElement('div');
          deleteButton.className = 'delete-history-btn btn btn-danger p-0';
          deleteButton.style = 'position:absolute; top: 5px; right: 5px; width: 25px; height: 25px';
          let span = document.createElement('span');
          span.className = 'ion-android-close';
          deleteButton.appendChild(span);
          node.appendChild(deleteButton);
          let editButton = document.createElement('div');
          editButton.className = 'edit-history-btn btn btn-secondary p-0';
          editButton.setAttribute('title', 'Edit name')
          editButton.style = 'position:absolute; top: 5px; right: 35px; width: 25px; height: 25px';
          span = document.createElement('span');
          span.className = 'ion-android-create';
          editButton.appendChild(span);
          
          node.appendChild(editButton);
          menu.appendChild(node);
        }
      }
      
      
      $(document).on('click', '.edit-history-btn', (e) => {
        let item = $(e.target).closest('.history-item')[0];
        let i = $('.history-item').index(item);
        let graph = savedGraphs[i];
        let newName = prompt('What is the new name of the graph?', graph.name);
        if(newName) {
          localStorage.removeItem('saved-graph-' + graph.name);
          if(localStorage.getItem('currentGraphName', graph.name)) {
            localStorage.setItem('currentGraphName', newName);
            showGraphName();
          }
          graph.name = newName;
          localStorage.setItem('saved-graph-' + graph.name, JSON.stringify(graph));
          loadSavedGraph();
        }
        e.stopPropagation();
      });
      
      $(document).on('click', '.delete-history-btn', (e) => {
        let item = $(e.target).closest('.history-item')[0];
        let i = $('.history-item').index(item);
        let name = savedGraphs[i].name;
        if(confirm(`Really delete ${name}?`)) {
          localStorage.removeItem('saved-graph-' + name);
          savedGraphs.splice(i, 1);
          if(name == localStorage.getItem('currentGraphName')) {
            loadGraph(savedGraphs[i > 0 ? i - 1 : i]);
          }
          item.remove();
        }
        e.stopPropagation();
      });

      function loadGraph(graph) {
        byProgram = true;
        editor.setValue(graph.pg);
        configEditor.setValue(graph.config);
        editor.getDoc().clearHistory();
        configEditor.getDoc().clearHistory();
        localStorage.setItem('pg', editor.getValue());
        localStorage.setItem('currentGraphName', graph.name);
        $('.dropdown-item.history-item').removeClass('active');
        $('.dropdown-item.history-item').removeClass('text-white');
        let i = savedGraphs.indexOf(graph);
        $(`.dropdown-item.history-item:eq(${i})`).addClass('active');
        $(`.dropdown-item.history-item:eq(${i})`).addClass('text-white');
        reloadConfig();
        showGraphName();
        byProgram = false;
      }
      
      $(document).on('click', '.history-item', (e) => {
        let i = $('.history-item').index(e.target);
        let graph = savedGraphs[i];
        loadGraph(graph);
      });
      
      function saveCurrentGraph() {
        let name = localStorage.getItem('currentGraphName');
        if(!name) {
          name = newGraphName();
        }
        let i = -1;
        let graph = {
          pg: editor.getValue(),
          config: configEditor.getValue(),
          name: name,
          date: Date.now()
        };
        while(i < savedGraphs.length - 1 && savedGraphs[++i].name !== name);
        if(i < savedGraphs.length) {
          savedGraphs[i] = graph;
        }
        localStorage.setItem('saved-graph-' + name, JSON.stringify(graph));
      }

      q('#new-btn').addEventListener('click', () => {
        let name = newGraphName();
        byProgram = true;
        editor.setValue('');
        configEditor.setValue(defaultConfig);
        localStorage.setItem('currentGraphName', name);
        saveCurrentGraph();
        loadSavedGraph();
        showGraphName();
        updateGraph('', defaultConfig);
        loadGraph({name:name, pg: '', config: defaultConfig});
        byProgram = false;
      });


      q('#reset-config-btn').addEventListener('click', () => {
        if(confirm("Really reset config?"))
          configEditor.setValue(defaultConfig);
      });

      q('#export-zip-btn').addEventListener('click', () => {
        var zip = new JSZip();
        let currentGraphName = localStorage.getItem('currentGraphName');
        let name = (currentGraphName.startsWith('Untitled') ? 'graph' : currentGraphName) + '_' + currentTimeString();
        zip.file("graph.pg", editor.getValue());
        zip.file("config.js", configEditor.getValue());
        zip.generateAsync({type:"blob"}).then(function (blob) {
          saveAs(blob, name + ".zip");
        });
      });

      
      q('#import-btn').addEventListener('click', () => {
        q('#import-btn-input').value = '';
      });

      q('#import-btn').addEventListener('change', (evt) => {
        function handleFile(f) {
          JSZip.loadAsync(f).then(function(zip) {
            if (!zip.file("graph.pg") || !zip.file("config.js")) {
              alert("Invalid zip file");
            } else {
              zip.file("graph.pg").async("string").then(function success(content) {
                let graph = content;
                zip.file("config.js").async("string").then(function success(content) {
                  let config = content;
                  // The same process as #new-btn is clicked
                  let name = newGraphName('Imported');
                  editor.setValue(graph);
                  configEditor.setValue(config);
                  saveCurrentGraph();
                  loadSavedGraph();
                  showGraphName();
                  loadGraph({name:name, pg: graph, config: config});
                });
              });
            }
          }, function (e) {
            alert("Error reading " + f.name + ": " + e.message);
          });
        }

        var files = evt.target.files; // A single file is accepted so far
        for (var i = 0; i < files.length; i++) {
          handleFile(files[i]);
        }
      });

      q('#export-cypher-btn').addEventListener('click', () => {

        let pg = pgParser.parse(editor.getValue());
        let output = "";
        pg.nodes.forEach(node => {
          let node_label = (node.labels[0] === undefined) ? "UNDEFINED" : node.labels[0]
          let query = "";
          query = query + "CREATE (v:" + node_label + " {"; // Restriction: single vertex label
          query = query + "id: '" + node.id + "'"; // ID is stored as a string property
          for (let entry of Object.entries(node.properties)) {
            query = query + ", " + entry[0] + ": '" + entry[1] + "'"; // values are always stored as sting
          }
          query = query + "});";
          output = output + query + '\n';
        });
        pg.edges.forEach(edge => {
          let edge_label = (edge.labels[0] === undefined) ? "UNDEFINED" : edge.labels[0]
          let query = "";
          query = query + "MATCH (src {id: '" + edge.from + "'}) MATCH (dst {id: '" + edge.to + "'}) CREATE (src)-[e:";
          query = query + edge_label;
          query = query + " {";
          for (let entry of Object.entries(edge.properties)) {
            query = query + ", " + entry[0] + ": '" + entry[1] + "'"; // values are always stored as sting
          }
          query = query + "}]->(dst);";
          output = output + query + '\n';
        });
        saveAs(new Blob([output], { type: 'text/plain' }), 'graph_' + currentTimeString() + '.cypher')
      });

      q('#export-pgql-btn').addEventListener('click', () => {
        let pg = pgParser.parse(editor.getValue());
        let graphName = localStorage.getItem('currentGraphName');
        let graphNamePGQL = graphName.replace('\'', '').replace(' ', '_').replace('-', '_').toLowerCase(); // must be simple SQL name
        let output = "";
        output = output + "CREATE PROPERTY GRAPH " + graphNamePGQL + ";\n";
        pg.nodes.forEach(node => {
          let node_label = (node.labels[0] === undefined) ? "UNDEFINED" : node.labels[0]
          let query = "";
          query = query + "INSERT INTO " + graphNamePGQL + " ";
          query = query + "VERTEX v LABELS (\"" + node_label.toUpperCase() + "\") "; // Restriction: single vertex label
          query = query + "PROPERTIES (";
          query = query + "v.id = '" + node.id + "'"; // ID is stored as a string property
          let json = "{\"ID\":[\"" + node.id + "\"]";
          for (let entry of Object.entries(node.properties)) {
            json = json + ", \"" + entry[0].toUpperCase() + "\":[\"" + entry[1] + "\"]"; // values are always stored as sting
          }
          json = json + "}";
          query = query + ", v.json = '" + json + "'";
          query = query + ");";
          output = output + query + '\n';
        });
        pg.edges.forEach(edge => {
          let edge_label = (edge.labels[0] === undefined) ? "UNDEFINED" : edge.labels[0]
          let query = "";
          query = query + "INSERT INTO " + graphNamePGQL + " ";
          query = query + "EDGE e BETWEEN src AND dst LABELS (\"" + edge_label.toUpperCase() + "\") "; // Restriction: single vertex label
          query = query + "PROPERTIES (";
          query = query + "e.direction = '" + edge.direction + "'";
          let json = "{\"FROM\":[\"" + edge.from + "\"], \"TO\":[\"" + edge.to + "\"]";
          for (let entry of Object.entries(edge.properties)) {
            json = json + ", \"" + entry[0].toUpperCase() + "\":[\"" + entry[1] + "\"]"; // values are always stored as sting
          }
          json = json + "}";
          query = query + ", e.json = '" + json + "'";
          query = query + ") ";
          query = query + "FROM MATCH ( (src), (dst) ) ON " + graphNamePGQL + " ";
          query = query + "WHERE src.id = '" + edge.from + "' AND dst.id = '" + edge.to + "';";
          output = output + query + '\n';
        });
        saveAs(new Blob([output], { type: 'text/plain' }), 'graph_' + currentTimeString() + '.pgql');
      });
      
      editor = CodeMirror.fromTextArea(q('#graph-input'), {
        lineNumbers: true,
        viewportMargin: Infinity,
        theme: "monokai",
        lineWrapping: true,
        mode: "pgMode",
        extraKeys: {
          Tab: 'autocomplete'
        },
        hintOptions: {
          completeSingle: false
        }
      });
      editor.setSize('100%', '100%');
      
      let oldHint = CodeMirror.hint.anyword;
      
      CodeMirror.hint.pgMode = function (editor) {
        let word =  /[\w$:]+/;
        let range = 200;
        let cur = editor.getCursor(), curLine = editor.getLine(cur.line);
        let end = cur.ch, start = end;
        while (start && word.test(curLine.charAt(start - 1))) --start;
        let curWord = start != end && curLine.slice(start, end);
        
        let list = [];
        
        for(let id of candidateIds) {
          if(id.includes(curWord) && id !== curWord)
            list.push(id);
        }
        
        for(let prop of candidatePropNames) {
          if(prop.includes(curWord) && prop !== curWord)
            list.push(prop);
        }
        
        for(let label of candidateLabels) {
          if(label.includes(curWord) && label !== curWord)
            list.push(label);
        }
        
        return {list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end)};
      };
      
      configEditor = CodeMirror.fromTextArea(q('#config-input'), {
        viewportMargin: Infinity,
        theme: "monokai",
        mode: { name: 'javascript', json: true },
        lineWrapping: true,
        extraKeys: {
          Tab: function(cm) {
            var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
            cm.replaceSelection(spaces);
          },
          "Shift-Tab": "indentLess"
        },
        hintOptions: {
          completeSingle: false,
        },
      });
      
      configEditor.setSize('100%', '100%');
      
      editor.on("inputRead", (instance) => {
        if(autocompletion)
          editor.execCommand('autocomplete', { completeSingle: false });
      });
      
      function reflectEditorChange() {
        localStorage.setItem('pg', editor.getValue());
        saveCurrentGraph();
        updateGraph(editor.getValue());
        clearTimeout(pgTimerId);
        pgTimerId = null; 
      }
      
      function onEditorChanged(delta){
        if(!byProgram) {
          clearTimeout(pgTimerId);
          localMode = true;
          pgTimerId = setTimeout(() => {
            reflectEditorChange();
          }, 2000);
        }
      }
            
      editor.on('keydown', (cm, e) => {
        if(e.ctrlKey && e.keyCode === 13) {
          // ctrl + enter
          reflectEditorChange();
        }
        // invoke only if timer is working
        else if(pgTimerId) onEditorChanged();
      });
      editor.on('change', onEditorChanged);
      editor.on('inputRead', onEditorChanged);
      
      editor.on('cursorActivity', (doc) => {
        if(!byProgram) {
          const node = blitzboard.nodeLineMap[doc.getCursor().line + 1];
          const edge = blitzboard.edgeLineMap[doc.getCursor().line + 1];
      
          if(node) {
            blitzboard.scrollNodeIntoView(node)
          } else if(edge){
            blitzboard.scrollEdgeIntoView(edge)
          }
        }
      });
      
      const urlParams = new URLSearchParams(window.location.search);
      let sampleName = urlParams.get('sample');
      if(sampleName) {
        loadSample(sampleName, (graph, config) => {
          localStorage.setItem('pg', graph);
          localStorage.setItem('config', config);
          localStorage.setItem('currentGraphName', newGraphName(sampleName));
          window.location.href = window.location.href.split('?')[0];
        });
      } else {
        let pgInParam = urlParams.get('pg'), nodePropInParam = urlParams.get('displayedNodeProps'),
          edgePropInParam = urlParams.get('displayedEdgeProps');
        let configInParam = urlParams.get('config');
        let graphNameInParam = urlParams.get('name');
        let viewModeInParam = urlParams.get('viewMode');
        if(pgInParam || nodePropInParam || edgePropInParam || configInParam || viewModeInParam) {
          if(pgInParam) {
            localStorage.setItem('pg', pgInParam);
            if(graphNameInParam) {
              localStorage.setItem('currentGraphName', graphNameInParam);
            } else {
              localStorage.setItem('currentGraphName', newGraphName());
            }
          }
          if(configInParam)
            localStorage.setItem('config', configInParam);
          if(viewModeInParam)
            localStorage.setItem('viewMode', viewModeInParam);
          window.location.href = window.location.href.split('?')[0]; // Jump to URL without query parameter
        }
                
        let initialPg = loadConfig('pg');
  
        let configText = loadConfig('config');
        
        if (!configText) {
          configText = defaultConfig;
        }
        if(!config) {
          config = tryJsonParse(configText);
        }
        
        if(config?.x2?.init) {
          editor.setValue('');
          let strParams = '?';
          config.x2.init.parameters.forEach(parameter => {
            strParams = strParams + parameter.key + '=' + parameter.value + '&';
          });
          const strUrl = config.x2.url + config.x2.init.endpoint + strParams;
          axios.get(strUrl).then((response) => {
            editor.setValue(json2pg.translate(JSON.stringify(response.data.pg)));
            editor.getDoc().clearHistory();
          });
        }
        // Otherwise, load PG data from browser local storage
        else if(initialPg) {
          editor.setValue(initialPg);
          editor.getDoc().clearHistory();
        }
        configEditor.setValue(configText);
        configEditor.getDoc().clearHistory();
        
        function tryJsonParse(json) {
          try {
            return looseJsonParse(json);
          } catch(e) {
            console.log(e);
            toastr.error(e.toString(), 'JSON SyntaxError', {preventDuplicates: true});
            return null;
          }
        }
  
  
        function reloadConfig() {
          localStorage.setItem('config', configEditor.getValue());
          config = tryJsonParse(configEditor.getValue());
          saveCurrentGraph();
          updateGraph(editor.getValue(), config);
          clearTimeout(configTimerId);
          configTimerId = null;
        }
  
        function onConfigChanged(delta) {
          clearTimeout(configTimerId);
          configTimerId = setTimeout(reloadConfig, 2000);
        }
  
        configEditor.on('keydown', (cm, e) => {
          if(e.ctrlKey && e.keyCode === 13) {
            // ctrl + enter
            reloadConfig();
          }
          // invoke only if timer is working
          else if(configTimerId) onConfigChanged();
        });
  
        configEditor.on('change', onConfigChanged);
        configEditor.on('inputRead', onConfigChanged);
  
        if(editor.getValue())
          updateGraph(editor.getValue(), config);
  
        let autocompletionConfig = localStorage.getItem('autocompletion');
        if(autocompletionConfig !== null) {
          autocompletion = autocompletionConfig === 'true';
          $('#options-auto-complete-input').prop('checked', autocompletion);
        }
  
        $('#options-auto-complete').click(() => {
          autocompletion = $('#options-auto-complete-input').prop('checked');
          localStorage.setItem('autocompletion', autocompletion);
        });
  
        let optionsShowConfig = localStorage.getItem('optionsShowConfig');
        if(optionsShowConfig !== null) {
          showConfig = optionsShowConfig === 'true';
          $('#options-show-config-input').prop('checked', showConfig);
          showOrHideConfig();
        }
  
        $('#options-show-config').click(() => {
          showConfig = $('#options-show-config-input').prop('checked');
          localStorage.setItem('optionsShowConfig', showConfig);
        });
  
        switch(viewMode) {
          case 'input-only':
            $('#input-only-btn').button('toggle');
            $('#input-area').resizable('disable');
            $('#input-area').css('width', '100%');
            $('#graph-pane').css('width', '0px');
            onResize(null, null);
            break;
          case 'view-only':
            $('#view-only-btn').button('toggle');
            $('#input-area').resizable('disable');
            $('#input-area').css('width', '0px');
            $('#graph-pane').css('width', '100%');
            onResize(null, null);
            break;
        }
  
        $('[data-toggle="tooltip"]').tooltip()
        .on('click', function() {
          $(this).tooltip('hide');
        });
  
        if(!localStorage.getItem('saved-graph-' + localStorage.getItem('currentGraphName'))) {
          saveCurrentGraph();
        }
  
        loadSavedGraph();
        showGraphName();
      }
