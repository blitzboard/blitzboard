<!doctype html>
<html>
<head>
  <title>Network</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script> 
  <script type="text/javascript" src="./pg_parser_browserified.js"></script> 
  <style type="text/css">
    #mynetwork {
      width: 600px;
      height: 400px;
      border: 1px solid lightgray;
    }
  </style> 
</head>
<body>
<div id="mynetwork"></div>
<input type='file' id='pgfile' size='20'>
<script type="text/javascript">
 function createLabelText(elem) {
   return elem.labels.join("\n");
 }
 function createTitleText(elem) {
   var flattend_props = Object.entries(elem.properties).reduce((acc, prop) => acc.concat(`${prop[0]}:${prop[1].join(',')}`), []);
   return flattend_props.join("<br>");
 }

 function getRandomColor() {
   var letters = '0123456789ABCDEF';
   var color = '#';
   for (var i = 0; i < 6; i++) {
     color += letters[Math.floor(Math.random() * 16)];
   }
   return color;
 }

 
 function handleFileSelect(evt) {
   var files = evt.target.files; // FileList object
   // use the 1st file from the list
   const f = files[0];
   var reader = new FileReader();

   // Closure to capture the file information.
   reader.onload = (function(theFile) {
     return function(e) {
       console.log(e.target);
       let graph;
       let groups = new Set();
       let edgeColorMap = {};
       if(f.name.endsWith('.pg')) {
         graph = pgParser.parse(e.target.result);
       } else {
         graph = JSON.parse(e.target.result);
       }
       let nodes = new vis.DataSet(graph.nodes.map((node) => {
         const groupName = node.labels.join('_');
         groups.add(groupName);
         return {
           id: node.id,
           group: groupName,
           label: createLabelText(node),
           title: createTitleText(node)
         };
       }));
       let edges = new vis.DataSet(graph.edges.map((edge) => {
         const edgeLabel = edge.labels.join('_');
         if(!edgeColorMap[edgeLabel]) {
           edgeColorMap[edgeLabel] = getRandomColor();
         }
         return {
           from: edge.from,
           to: edge.to,
           color: edgeColorMap[edgeLabel],
           label: createLabelText(edge),
           title: createTitleText(edge)
         }
       }));
       // create a network
       var container = document.getElementById('mynetwork');
       var data = {
         nodes: nodes,
         edges: edges
       };
       var options = {
         groups: Object.keys(groups).reduce((acc, group) => {
           acc[group] = { color: getRandomColor() }
         }, {})
       };
       var network = new vis.Network(container, data, options);        
     };
   })(f);
   // Read in the image file as a data URL.
   reader.readAsText(f);
 };
 document.getElementById('pgfile').addEventListener('change', handleFileSelect, false);
</script> 
</body>
</html>
