<!doctype html>
<html>
<head>
  <title> Hello Graph </title>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script> 
  <script type="text/javascript" src="./pg_parser_browserified.js"></script> 
  <style type="text/css">
    #mynetwork {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
    }
    #input-area {
      position: fixed;
      bottom: 5px;
    }
    #pgfile {
      position: relative;
    }
  </style> 
</head>
<body>
  <div id="mynetwork"></div>
  <div id="input-area">
    <input type='file' id='pgfile'>
    <textarea id="graph-input" style="resize: none; width: 100%; height: 80px;">
    </textarea>
  </div>
<script type="text/javascript">
 'use strict';
 const $ = document.querySelector.bind(document);
 let timerId = 0;
 
 function createLabelText(elem) {
   return elem.labels.join("\n");
 }
 
 function createTitleText(elem) {
   let flattend_props = Object.entries(elem.properties).reduce((acc, prop) => acc.concat(`${prop[0]}:${prop[1].join(',')}`), []);
   return flattend_props.join("<br>");
 }

 function getRandomColor() {
   let letters = '0123456789ABCDEF';
   let color = '#';
   for (let i = 0; i < 6; i++) {
     color += letters[Math.floor(Math.random() * 16)];
   }
   return color;
 }

 function updateGraph() {
   let graph;
   let groups = new Set();
   let edgeColorMap = {};
   let input = $('#graph-input').value;
   try {
     graph = JSON.parse(input);
   } catch(err) {
     if(err instanceof SyntaxError)
       graph = pgParser.parse(input);
     else
       throw err;
   }
   
   let nodes = new vis.DataSet(graph.nodes.map((node) => {
     const groupName = node.labels.join('_');
     groups.add(groupName);
     return {
       id: node.id,
       group: groupName,
       label: createLabelText(node),
       shape: 'dot',
       title: createTitleText(node)
     };
   }));
   let edges = new vis.DataSet(graph.edges.map((edge) => {
     const edgeLabel = edge.labels.join('_');
     if(!edgeColorMap[edgeLabel]) {
       edgeColorMap[edgeLabel] = getRandomColor();
     }
     return {
       from: edge.from,
       to: edge.to,
       color: edgeColorMap[edgeLabel],
       label: createLabelText(edge),
       title: createTitleText(edge)
     }
   }));
   // create a network
   let container = document.getElementById('mynetwork');
   let data = {
     nodes: nodes,
     edges: edges
   };
   let options = {
     groups: Object.keys(groups).reduce((acc, group) => {
       acc[group] = { color: getRandomColor() }
     }, {}),
     layout: {
       randomSeed: 1,
     },
   };
   new vis.Network(container, data, options);        
 }
 
 function handleFileSelect(evt) {
   let files = evt.target.files; // FileList object
   // use the 1st file from the list
   const f = files[0];
   let reader = new FileReader();


   // Closure to capture the file information.
   reader.onload = (function(theFile) {
     return function(e) {
       $('#graph-input').value = e.target.result;
       updateGraph();
     };
   })(f);
   // Read in the image file as a data URL.
   reader.readAsText(f);
 };
 
 
 $('#pgfile').addEventListener('change', handleFileSelect, false);
 $('#graph-input').value =
 `node1 :You name:"your name"
node2 :Graph type:"graph"
node1 -> node2 :Hello! on:"today"`;
 updateGraph();
 $('#graph-input').addEventListener('input', () => {
   clearTimeout(timerId);
   timerId = setTimeout(updateGraph, 1000);
 });
</script> 
</body>
</html>
